/**
 * @name Codex Test
 * @description Connects to a running Codex app-server, starts a thread, sends a prompt with model context, and logs the response.
 * @version 1.0.0
 * @author Thomas Rohde
 * @lastModifiedDate 2026-02-22
 */

console.clear();
console.show();

load(__DIR__ + "lib/log.js");
load(__DIR__ + "lib/requireModel.js");
load(__DIR__ + "lib/planOps.js");
load(__DIR__ + "lib/codexClient.js");

(function () {
    "use strict";

    try {
        log.header("Codex Test");
        requireModel();

        // ── Connect ─────────────────────────────────────────────────────
        log.info("Connecting to Codex app-server...");
        var initResult = codexClient.connect();
        log.success("Connected. Server: " + JSON.stringify(initResult));

        // ── Build model context ─────────────────────────────────────────
        log.info("Building model context...");
        var context = codexClient.buildModelContext({
            maxElements: 50,
            relationships: true,
            includeDocumentation: true
        });
        log.detail("Context length: " + context.length + " chars");

        // ── Start thread ────────────────────────────────────────────────
        log.info("Starting thread...");
        var thread = codexClient.startThread({
            approvalPolicy: "never"
        });
        log.success("Thread started: " + thread.id);

        // ── Ask a question ──────────────────────────────────────────────
        var prompt = "Here is an ArchiMate model. Summarize the architecture in 3-5 bullet points.\n\n" + context;

        log.info("Sending prompt (" + prompt.length + " chars)...");
        var result = codexClient.ask(thread.id, prompt, {
            onDelta: function (delta) {
                // Stream text to console as it arrives (runs on script thread)
            }
        });

        log.info("─── Response ───");
        log.info(result.text);
        log.detail("Status: " + result.status);
        log.detail("Items: " + result.items.length);

        // ── Disconnect ──────────────────────────────────────────────────
        codexClient.disconnect();
        log.success("Codex Test complete.");

    } catch (error) {
        log.error("Script failed: " + error.toString());
        if (error.stack) log.error(error.stack);
        // Clean up connection on error
        try { codexClient.disconnect(); } catch (e) { /* ignore */ }
        window.alert("Error: " + error.message);
    }
})();
